@*
 * Copyright 2020 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import cats.instances.long._
@import cats.syntax.eq._
@import java.time.LocalDate
@import uk.gov.hmrc.cgtpropertydisposalsfrontend.config.ViewConfig
@import uk.gov.hmrc.cgtpropertydisposalsfrontend.controllers.actions.RequestWithSessionData
@import uk.gov.hmrc.cgtpropertydisposalsfrontend.controllers.returns.acquisitiondetails.routes
@import uk.gov.hmrc.cgtpropertydisposalsfrontend.models.returns.AcquisitionDetailsAnswers.CompleteAcquisitionDetailsAnswers
@import uk.gov.hmrc.cgtpropertydisposalsfrontend.models.LocalDateUtils
@import uk.gov.hmrc.cgtpropertydisposalsfrontend.models.finance.MoneyUtils
@import uk.gov.hmrc.cgtpropertydisposalsfrontend.models.returns.AcquisitionMethod
@import uk.gov.hmrc.cgtpropertydisposalsfrontend.models.UserType

@this(
        cyaSection: uk.gov.hmrc.cgtpropertydisposalsfrontend.views.html.components.cya_section,
        cyaRow: uk.gov.hmrc.cgtpropertydisposalsfrontend.views.html.components.cya_row,
        cyaChange: uk.gov.hmrc.cgtpropertydisposalsfrontend.views.html.components.cya_change,
        addressDisplay: uk.gov.hmrc.cgtpropertydisposalsfrontend.views.html.components.address_display,
)

@(
        answers: CompleteAcquisitionDetailsAnswers,
        cutoffDate: LocalDate,
        isUk: Boolean,
        canRebase: Boolean,
        isATrust: Boolean
)(implicit request: RequestWithSessionData[_], messages: Messages, viewConfig: ViewConfig)
@isAgent = @{ request.userType.contains(UserType.Agent) }
@userKey = @{if (isAgent) ".agent" else if (isATrust) ".trust" else ""}
@rebasingKey = @{if(canRebase && answers.shouldUseRebase) ".rebased" else ""}
@acquisitionMethodAndPriceTitle = @{
  answers.acquisitionMethod match {
    case AcquisitionMethod.Bought => (messages("returns.acquisitionMethod.Bought"), messages(s"acquisitionPriceBought$userKey.title"))
    case AcquisitionMethod.Inherited => (messages("returns.acquisitionMethod.Inherited"), messages(s"acquisitionPriceNotBought$userKey.title", LocalDateUtils.govDisplayFormat(answers.acquisitionDate.value)))
    case AcquisitionMethod.Gifted => (messages("returns.acquisitionMethod.Gifted"), messages(s"acquisitionPriceNotBought$userKey.title", LocalDateUtils.govDisplayFormat(answers.acquisitionDate.value)))
    case AcquisitionMethod.Other(value) => (value, messages(s"acquisitionPriceNotBought$userKey.title", LocalDateUtils.govDisplayFormat(answers.acquisitionDate.value)))
  }
}

@cyaSection() {
  @cyaRow(
    messages(s"acquisitionMethod$userKey.title"),
    Html(acquisitionMethodAndPriceTitle._1),
    Some(cyaChange(messages("acquisitionDetails.cyaChange.acquisitionMethod"), routes.AcquisitionDetailsController.acquisitionMethod().url)),
    "acquisitionMethod"
  )
  @cyaRow(
    messages(s"acquisitionDate$userKey.title"),
    Html(LocalDateUtils.govDisplayFormat(answers.acquisitionDate.value)),
    Some(cyaChange(messages("acquisitionDetails.cyaChange.acquisitionDate"), routes.AcquisitionDetailsController.acquisitionDate().url)),
    "acquisitionDate"
  )

@if((isUk && !canRebase) || !isUk) {
  @cyaRow(
      acquisitionMethodAndPriceTitle._2,
        Html(MoneyUtils.formatAmountOfMoneyWithPoundSign(answers.acquisitionPrice.inPounds())),
        Some(cyaChange(messages("acquisitionDetails.cyaChange.acquisitionPrice"), routes.AcquisitionDetailsController.acquisitionPrice().url)),
        "acquisitionPrice"
  )
}

@if(canRebase && answers.shouldUseRebase) {
  @answers.rebasedAcquisitionPrice.map{ rebasedValue =>
    @cyaRow(
      messages("rebaseAcquisitionPrice.title", LocalDateUtils.govShortDisplayFormat(cutoffDate)),
      Html(MoneyUtils.formatAmountOfMoneyWithPoundSign(rebasedValue.inPounds())),
      Some(cyaChange(messages("acquisitionDetails.cyaChange.rebasedAcquisitionPrice"), routes.AcquisitionDetailsController.rebasedAcquisitionPrice().url)),
      "rebasedAcquisitionPrice-value"
    )
  }
}

@if(!isUk && canRebase) {
    @cyaRow(
      messages("shouldUseRebase.title", LocalDateUtils.govShortDisplayFormat(cutoffDate)),
      Html(messages(if(answers.shouldUseRebase) "generic.yes" else "generic.no")),
      Some(cyaChange(messages("acquisitionDetails.cyaChange.shouldUseRebase"), routes.AcquisitionDetailsController.shouldUseRebase().url)),
      "shouldRebase"
    )
}

@if(answers.improvementCosts.value === 0L){
  @cyaRow(
      messages(s"improvementCosts$userKey.title"),
      Html(messages("generic.no")),
      Some(cyaChange(messages("acquisitionDetails.cyaChange.improvementCosts"), routes.AcquisitionDetailsController.improvementCosts().url)),
      "improvementCosts"
    )
  } else {
    @cyaRow(
      messages(s"improvementCosts$userKey.title"),
      Html(messages("generic.yes")),
      Some(cyaChange(messages("acquisitionDetails.cyaChange.improvementCosts"), routes.AcquisitionDetailsController.improvementCosts().url)),
      "improvementCosts"
    )
    @cyaRow(
      messages("improvementCostsValue.label"),
      Html(MoneyUtils.formatAmountOfMoneyWithPoundSign(answers.improvementCosts.inPounds())),
      Some(cyaChange(messages("acquisitionDetails.cyaChange.improvementCosts"), routes.AcquisitionDetailsController.improvementCosts().url)),
      "improvementCosts-value"
    )
  }
  @if(answers.acquisitionFees.value === 0L){
    @cyaRow(
      messages(s"acquisitionFees$userKey$rebasingKey.title"),
      Html(messages("generic.no")),
      Some(cyaChange(messages(s"acquisitionDetails$rebasingKey.cyaChange.acquisitionFees"), routes.AcquisitionDetailsController.acquisitionFees().url)),
      "acquisitionFees"
    )
  } else {
    @cyaRow(
      messages(s"acquisitionFees$userKey$rebasingKey.title"),
      Html(messages("generic.yes")),
      Some(cyaChange(messages(s"acquisitionDetails$rebasingKey.cyaChange.acquisitionFees"), routes.AcquisitionDetailsController.acquisitionFees().url)),
      "acquisitionFees"
    )
    @cyaRow(
      messages("acquisitionFeesValue.label"),
      Html(MoneyUtils.formatAmountOfMoneyWithPoundSign(answers.acquisitionFees.inPounds())),
      Some(cyaChange(messages("acquisitionDetails.cyaChange.acquisitionFees"), routes.AcquisitionDetailsController.acquisitionFees().url)),
      "acquisitionFees-value"
    )
  }
}